@page "/SpeakingRosesTest/TasksPage"

@using SpeakingRosesTest.Areas.SpeakingRosesTest.TasksBack.Repositories;
@using SpeakingRosesTest.Areas.SpeakingRosesTest.TasksBack.Services;
@using SpeakingRosesTest.Areas.SpeakingRosesTest.TasksBack.Entities;
@using SpeakingRosesTest.Areas.SpeakingRosesTest.TasksBack.DTOs;
@inject TasksRepository tasksRepository;
@inject TasksService tasksService;

<PageTitle>Search tasks - Speaking Roses Test</PageTitle>

<SpeakingRosesTest.Components.Layout.SideNav></SpeakingRosesTest.Components.Layout.SideNav>

<div class="main-content position-relative max-height-vh-100 h-100">
    <SpeakingRosesTest.Components.Layout.NavBarDashboard Pagina="Tasks"></SpeakingRosesTest.Components.Layout.NavBarDashboard>
    <div class="container-fluid px-2 px-md-4">
        <div class="page-header min-height-300 border-radius-xl mt-4"
        style="background-image: url('img/System/Landscape.jpg');">
            <span class="mask bg-gradient-dark opacity-6"></span>
        </div>
        <div class="card mx-3 mx-md-4 mt-n6">
            <!--CARD HEADER-->
            <div class="card-header mb-0 pb-0">
                <h3 class="mb-3">
                    Search tasks
                </h3>
                <NavLink class="btn btn-outline-dark" href="Dashboard">
                    <span class="fas fa-chevron-left" aria-hidden="true"></span>
                    &nbsp;Go back
                </NavLink>
                <NavLink class="btn btn-success text-white" href="SpeakingRosesTest/TasksPage/0">
                    <span class="fas fa-plus" aria-hidden="true"></span>
                    &nbsp;Create task
                </NavLink>
                <hr />
            </div>
            <!--CARD BODY-->
            <div class="card-body px-3">
                @((MarkupString)Message)
                <div class="row">
                    <div class="col-12 col-md-4">
                        <!--Searchbox-->
                        <div class="input-group input-group-dynamic">
                            <span class="input-group-text">
                                <i class="fas fa-search" aria-hidden="true"></i>
                            </span>
                            <input class="form-control" 
                            @oninput="SearchText"
                            placeholder="Search task by TasksId..."
                            type="search">
                        </div>
                        <br />
                        <!--Strict or lax search-->
                        <div>
                            <h6>
                                <b>
                                    Strict or lax search
                                    <button type="button" 
                                    class="btn btn-outline-dark" 
                                    data-bs-toggle-tooltip="tooltip" 
                                    data-bs-placement="right"
                                    title="A lax search is more flexible, allows for errors, and returns broader results, something that a strict search does not allow.">
                                        <i class="fas fa-circle-info"></i>
                                    </button>
                                </b>
                            </h6>
                            
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                type="checkbox"
                                name="strict-search"
                                @bind="CheckStrict"
                                id="strict-search" />
                                <label class="form-check-label"
                                for="strict-search">
                                    Strict search
                                </label>
                            </div>
                        </div>
                        <br/>
                        <!--View type-->
                        <h6>
                            <b>
                                View type
                            </b>
                        </h6>
                        <div class="btn-group mb-3" role="group" aria-label="btngroup">
                            <button type="button"
                            class="btn btn-dark"
                            onclick=@(() => ChangeView("table"))>
                                <i class="fas fa-table"></i>
                                Table
                            </button>
                            <button type="button"
                            class="btn btn-dark"
                            onclick=@(() => ChangeView("list"))>
                                <i class="fas fa-th-list"></i>
                                List
                            </button>
                        </div>
                        <br />
                        <!--Registers per page-->
                        <h6>
                            <b>
                                Registers per page
                            </b>
                        </h6>
                        <div class="dropdown">
                            <button class="btn btn-dark dropdown-toggle"
                            type="button"
                            id="dropdown-registers-per-page"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                                See @RegistersPerPage
                            </button>
                            <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdown-registers-per-page">
                                <li>
                                    <a class="dropdown-item border-radius-md"
                                    href="javascript:;"
                                    @onclick="(() => ChangeRegistersPerPage(50))">
                                        50
                                    </a>
                                </li>
                                <li>
                                    <button class="dropdown-item border-radius-md"
                                    @onclick="(() => ChangeRegistersPerPage(500))">
                                        500
                                    </button>
                                </li>
                                <li>
                                    <a class="dropdown-item border-radius-md"
                                    href="javascript:;"
                                    @onclick="(() => ChangeRegistersPerPage(5000))">
                                        5.000
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <div class="row">
                            <div class="d-flex justify-content-start">
                                <!--Import function-->
                                <button type="button" 
                                class="btn btn-outline-dark mx-2" 
                                data-bs-toggle="modal"
                                data-bs-target="#modal-import"
                                data-bs-placement="bottom"
                                data-bs-toggle-tooltip="tooltip"
                                title="Import">
                                    <i class="fas fa-file-import fa-xl"></i>
                                </button>
                                <div class="modal fade"
                                     id="modal-import"
                                     tabindex="-1"
                                     aria-labelledby="modal-import-title"
                                     aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" 
                                                id="modal-import-title">
                                                    Import
                                                </h5>
                                            </div>
                                            <div class="modal-body">
                                                <form role="form">
                                                    <div class="input-group input-group-static mb-3">
                                                        <label for="importingfile">
                                                            File to import
                                                        </label>
                                                        <InputFile type="file"
                                                        id="importingfile"
                                                        class="form-control"
                                                        OnChange="@UploadImportingFile" />
                                                        @{
                                                            var ProgressCssForImportingFile = "progress" + (DisplayProgressForImportingFile ? "" : "d-none");
                                                            var ProgressWidthStyleForImportingFile = ProgressPercentForImportingFile + "%";
                                                        }
                                                        <!--Progress bar-->
                                                        <div class="@ProgressCssForImportingFile">
                                                            <div class="progress-bar progress-bar-striped progress-bar-animated @ProgressBarColourForImportingFile"
                                                            role="progressbar" style="width:@ProgressWidthStyleForImportingFile"
                                                            area-valuenow="@ProgressPercentForImportingFile"
                                                            aria-valuemin="0"
                                                            aria-valuemax="100">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group mb-3">
                                                        <!-- Import from Excel button -->
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="ImportExcel">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-file-excel"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Import from Excel file
                                                            </span>
                                                        </button>
                                                    </div>
                                                </form>
                                                @((MarkupString)ImportingMessage)
                                            </div>
                                            <div class="modal-footer justify-content-end">
                                                <button type="button" 
                                                class="btn btn-outline-dark mb-0" 
                                                data-bs-dismiss="modal">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--Export function-->
                                <button type="button"
                                class="btn btn-outline-dark mx-2"
                                data-bs-toggle="modal"
                                data-bs-target="#modal-export"
                                data-bs-placement="bottom"
                                data-bs-toggle-tooltip="tooltip"
                                title="Export">
                                    <i class="fas fa-file-export fa-xl"></i>
                                </button>
                                <div class="modal fade"
                                    id="modal-export"
                                    tabindex="-1" 
                                    aria-labelledby="modal-export-title" 
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" 
                                                id="modal-export-title">
                                                    Export
                                                </h5>
                                            </div>
                                            <div class="modal-body">
                                                <form role="form">
                                                    <h6>
                                                        Registers to export
                                                    </h6>
                                                    <div class="form-group mb-3">
                                                        <div class="custom-control custom-radio">
                                                            <input name="export" 
                                                            type="radio" 
                                                            class="custom-control-input" 
                                                            checked
                                                            id="export-just"
                                                            value="just"
                                                            @onchange="@(() => ExportationType = "just")">
                                                            <label class="custom-control-label" 
                                                            for="export-just">
                                                                Only selected records
                                                            </label>
                                                        </div>
                                                        <div class="custom-control custom-radio">
                                                            <input name="export"
                                                            type="radio" 
                                                            class="custom-control-input"
                                                            id="export-all"
                                                            value="all"
                                                            @onchange="@(() => ExportationType = "all")">
                                                            <label class="custom-control-label" 
                                                            for="export-all">
                                                                All
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <h6>
                                                        Formats
                                                    </h6>
                                                    <!-- Export as PDF file button -->
                                                    <div class="d-flex justify-content-start">
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="ExportToPDF">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-file-pdf"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Export as PDF
                                                            </span>
                                                        </button>
                                                        @if (DownloadPathForPDF != "")
                                                        {
                                                            <a class="btn btn-icon btn-success mx-3"
                                                            download
                                                            href="@DownloadPathForPDF">
                                                                Download
                                                            </a>
                                                        }
                                                    </div>
                                                    <!-- Export as Excel file button -->
                                                    <div class="d-flex justify-content-start">
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="ExportToExcel">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-file-excel"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Export as Excel
                                                            </span>
                                                        </button>
                                                        @if (DownloadPathForExcel != "")
                                                        {
                                                            <a class="btn btn-icon btn-success mx-3"
                                                            download
                                                            href="@DownloadPathForExcel">
                                                                Download
                                                            </a>
                                                        }
                                                    </div>
                                                    <!-- Export as CSV file button -->
                                                    <div class="d-flex justify-content-start">
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="ExportToCSV">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-file-csv"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Export as CSV
                                                            </span>
                                                        </button>
                                                        @if (DownloadPathForCSV != "")
                                                        {
                                                            <a class="btn btn-icon btn-success mx-3"
                                                            download
                                                            href="@DownloadPathForCSV">
                                                                Download
                                                            </a>
                                                        }
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer justify-content-end">
                                                <button type="button" 
                                                class="btn btn-outline-dark mb-0" 
                                                data-bs-dismiss="modal">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--Massive actions-->
                                <button type="button"
                                class="btn btn-outline-dark mx-2"
                                data-bs-toggle="modal"
                                data-bs-target="#modal-massive-actions"
                                data-bs-placement="bottom"
                                data-bs-toggle-tooltip="tooltip"
                                title="Massive actions">
                                    <i class="fas fa-rocket fa-xl"></i>
                                </button>
                                <div class="modal fade"
                                id="modal-massive-actions"
                                tabindex="-1"
                                aria-labelledby="modal-massive-actions-title"
                                aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title"
                                                id="modal-massive-actions-title">
                                                    Massive actions
                                                </h5>
                                            </div>
                                            <div class="modal-body">
                                                <form role="form">
                                                    <h6>
                                                        Registers to select
                                                    </h6>
                                                    <div class="form-group mb-3">
                                                        <div class="custom-control custom-radio">
                                                            <input name="massiveactions"
                                                            type="radio"
                                                            class="custom-control-input"
                                                            checked
                                                            id="massiveactions-just"
                                                            @onchange="@(() => MassiveActionType = "just")">
                                                            <label class="custom-control-label"
                                                            for="massiveactions-just">
                                                                Only selected records
                                                            </label>
                                                        </div>
                                                        <div class="custom-control custom-radio">
                                                            <input name="massiveactions"
                                                            type="radio"
                                                            class="custom-control-input"
                                                            id="massiveactions-all"
                                                            @onchange="@(() => MassiveActionType = "all")">
                                                            <label class="custom-control-label"
                                                            for="massiveactions-all">
                                                                All
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <h6>
                                                        Actions
                                                    </h6>
                                                    <div class="form-group">
                                                        <!-- Copy button -->
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="Copy">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-copy"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Copy
                                                            </span>
                                                        </button>
                                                    </div>
                                                    <div class="form-group">
                                                        <!-- Delete button -->
                                                        <button class="btn btn-icon btn-dark"
                                                        type="button"
                                                        @onclick="Delete">
                                                            <span class="btn-inner--icon">
                                                                <i class="fas fa-trash"></i>
                                                            </span>
                                                            <span class="btn-inner--text">
                                                                Delete
                                                            </span>
                                                        </button>
                                                    </div>
                                                </form>
                                                @((MarkupString)MassiveActionMessage)
                                            </div>
                                            <div class="modal-footer justify-content-end">
                                                <button type="button" 
                                                class="btn btn-outline-dark mb-0" 
                                                data-bs-dismiss="modal">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--Number of registers-->
                <h6 class="mt-3">
                    <b>
                        Number of tasks: @TotalRows
                    </b>
                </h6>
                <!--Table-->
                @if (ChosenView == "table")
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered mt-4">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Priority</th>
                                    <th>Due date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (paginatedTasksDTO != null)
                                {
                                    @for (int i = 0; i < paginatedTasksDTO.lstTasks.Count(); i++)
                                    {
                                        int tasksId = @paginatedTasksDTO.lstTasks[i]!.TasksId;

                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                @onchange="(() => CheckList(tasksId))" />
                                            </td>
                                            <td>@paginatedTasksDTO.lstTasks[i]?.TasksId</td>
                                            <td>@paginatedTasksDTO.lstTasks[i]?.Title</td>
                                            <td>@paginatedTasksDTO.lstTasks[i]?.Description</td>
                                            <td>@paginatedTasksDTO.lstPriority[i]?.Name</td>
                                            <td>@paginatedTasksDTO.lstTasks[i]?.DueDate</td>
                                            <td>@paginatedTasksDTO.lstStatus[i]?.Name</td>
                                        

                                            <td>
                                                <div class="d-flex justify-content-start">
                                                    <a class="btn btn-sm btn-outline-info mx-2"
                                                       href="SpeakingRosesTest/TasksPage/@paginatedTasksDTO.lstTasks[i]?.TasksId">
                                                        <span class="fas fa-pen" aria-hidden="true"></span>
                                                    </a>
                                                    <button class="btn btn-outline-danger btn-sm toast-delete showtoast">
                                                        <span class="fas fa-trash" aria-hidden="true"></span>
                                                    </button>
                                                    <div class="toast bg-gradient-dark fade p-2 mx-auto"
                                                         role="alert"
                                                         aria-live="assertive"
                                                         aria-atomic="true">
                                                        <div class="toast-header border-0 bg-transparent">
                                                            <i class="fas fa-circle-xmark me-2 text-white"></i>
                                                            <span class="me-auto font-weight-bold text-white">Confirmar eliminación</span>
                                                            <i class="fas fa-times text-md ms-3 cursor-pointer text-white closetoast" data-bs-dismiss="toast" aria-label="Close"></i>
                                                        </div>
                                                        <hr class="horizontal light m-0">
                                                        <div class="toast-body text-white">
                                                            Are you sure you want to delete
                                                            <br/>
                                                            this record with ID @tasksId?
                                                            <br />
                                                            Press YES to delete
                                                            <br />
                                                            <button class="btn btn-outline-danger btn-sm mt-2 closetoast"
                                                                    onclick=@(() => Delete(tasksId))>
                                                                YES
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <!--List-->
                    @if (paginatedTasksDTO != null)      
                    {
                        <div class="row">
                            @for (int i = 0; i < paginatedTasksDTO.lstTasks.Count(); i++)
                            {
                                int tasksId = @paginatedTasksDTO.lstTasks[i]!.TasksId;
                                
                                <div class="col-12 col-md-4 mb-4">
                                    <div class="card shadow-lg mt-2">
                                        <div class="card-body">
                                            <p><b>ID: </b>@paginatedTasksDTO.lstTasks[i]?.TasksId</p>
                                            <p><b>Title: </b>@paginatedTasksDTO.lstTasks[i]?.Title</p>
                                            <div><b>Description: </b>@paginatedTasksDTO.lstTasks[i]?.Description</div>
                                            <p><b>Priority: </b>@paginatedTasksDTO.lstPriority[i]?.Name</p>
                                            <p><b>Due date: </b>@paginatedTasksDTO.lstTasks[i]?.DueDate</p>
                                            <p><b>Status: </b>@paginatedTasksDTO.lstStatus[i]?.Name</p>
                                        
                                        </div>
                                        <div class="card-footer text-body-secondary">
                                            <div class="d-flex justify-content-end">
                                                <style>
                                                    input.larger-checkbox {
                                                        width: 60px;
                                                        height: 30px;
                                                    }
                                                </style>
                                                <input class="larger-checkbox"
                                                           type="checkbox"
                                                           @onchange="(() => CheckList(tasksId))" />
                                                <a class="btn btn-outline-info mx-3"
                                                   href="SpeakingRosesTest/TasksPage/@paginatedTasksDTO.lstTasks[i]?.TasksId">
                                                    <span class="fas fa-pen" aria-hidden="true"></span>
                                                </a>
                                                <button 
                                                    class="btn btn-outline-danger toast-delete showtoast">
                                                    <span class="fas fa-trash" aria-hidden="true"></span>
                                                </button>
                                                <div class="toast bg-gradient-dark fade p-2 mx-auto" 
                                                role="alert" 
                                                aria-live="assertive" 
                                                aria-atomic="true">
                                                    <div class="toast-header border-0 bg-transparent">
                                                        <i class="fas fa-circle-xmark me-2 text-white"></i>
                                                        <span class="me-auto font-weight-bold text-white">Confirmar eliminación</span>
                                                        <i class="fas fa-times text-md ms-3 cursor-pointer text-white closetoast" data-bs-dismiss="toast" aria-label="Close"></i>
                                                    </div>
                                                    <hr class="horizontal light m-0">
                                                    <div class="toast-body text-white">
                                                        Are you sure you want to delete this record with ID @tasksId? Press YES to delete
                                                        <br/>
                                                        <button class="btn btn-outline-danger btn-sm mt-2 closetoast"
                                                                onclick=@(() => Delete(tasksId))>
                                                            YES
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
                <!--Pagination-->
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center mt-3">
                        <li class="page-item
                        @(paginatedTasksDTO!.HasPreviousPage ? "" : "disabled")">
                            <button class="page-link"
                                    disabled="@(!paginatedTasksDTO.HasPreviousPage)"
                                    @onclick="() => OnPreviousPage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </li>
                        @for (int i = 1; i <= paginatedTasksDTO.TotalPages; i++)
                        {
                            int currentPage = i;
                            <li class="page-item
                            @(i == paginatedTasksDTO.PageIndex ? "active" : "")">
                                <button class="page-link"
                                        onclick=@(() => OnPageSelected(currentPage))>
                                    @i
                                </button>
                            </li>
                        }
                        <li class="page-item
                        @(paginatedTasksDTO.HasNextPage ? "" : "disabled")">
                            <button class="page-link"
                                    disabled="@(!paginatedTasksDTO.HasNextPage)"
                                    @onclick="() => OnNextPage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Initialization of tooltip -->
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle-tooltip="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>

    <SpeakingRosesTest.Components.Layout.FixedPlugin></SpeakingRosesTest.Components.Layout.FixedPlugin>
    <SpeakingRosesTest.Components.Layout.FooterDashboard></SpeakingRosesTest.Components.Layout.FooterDashboard>

</div>

@code {
    #region Properties
    public int TotalRows { get; set; } = 0;

    public string? ChosenView { get; set; }

    public bool CheckStrict { get; set; }

    public string? TextToSearch { get; set; } = "";

    public string? Message { get; set; } = "";

    public string? ExportationType { get; set; } = "just";
    public string? MassiveActionType { get; set; } = "just";

    public string? DownloadPathForExcel { get; set; } = "";
    public string? DownloadPathForPDF { get; set; } = "";
    public string? DownloadPathForCSV { get; set; } = "";

    public Tasks Tasks = new();

    paginatedTasksDTO paginatedTasksDTO = new();

    public List<int> lstTasksChecked = [];

    public int RegistersPerPage { get; set; } = 50;

    //Data for importing file
    public bool DisplayProgressForImportingFile { get; set; } = false;
    public int ProgressPercentForImportingFile { get; set; } = 0;
    public string ProgressTextForTextFile { get; set; } = "";
    public string ProgressBarColourForImportingFile { get; set; } = "bg-info";
    public string UploadPath { get; set; } = "";
    public string ImportingMessage { get; set; } = "";

    public string MassiveActionMessage { get; set; } = "";
    #endregion

    protected override void OnInitialized()
    {
        try
        {
            paginatedTasksDTO = new();
            paginatedTasksDTO.lstTasks = [];

            paginatedTasksDTO = tasksRepository
                                    .GetAllByTasksIdPaginated(
                                        "",
                                        CheckStrict,
                                        1,
                                        RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            ChosenView = "list";

            base.OnInitialized();
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {

        }
    }

    private async Task ResetData()
    {
        try
        {
            Message = $@"";
        }
        catch (Exception ex)
        {
            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                            There was an error. Please, try again. Error message: {ex.Message}
                         </div>";

            ProgressPercentForImportingFile = 100;
            ProgressBarColourForImportingFile = "bg-danger";
        }
        finally
        {
            //Re-render the page to show ScannedText
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    #region Events
    private async Task ImportExcel()
    {
        try
        {
            if (!UploadPath.EndsWith(".xlsx"))
            {
                ImportingMessage = $@"<div class=""alert alert-warning text-white font-weight-bold"" role=""alert"">
                            Only Excel files (.xlsx) are allowed
                         </div>";
                return;
            }

            UploadPath = $@"wwwroot/{UploadPath.Replace("\\","/")}";

            List<Tasks> lstTasks = tasksService.ImportExcel(UploadPath);

            foreach (Tasks Tasks in lstTasks)
            {
                tasksRepository.Add(Tasks);
            }

            paginatedTasksDTO = tasksRepository
                                                .GetAllByTasksIdPaginated(
                                                    "",
                                                    CheckStrict,
                                                    1,
                                                    RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            ChosenView = "list";

            ImportingMessage = $@"<div class=""alert alert-success text-white font-weight-bold"" role=""alert"">
                            Importación finalizada correctamente.
                         </div>";
        }
        catch (Exception ex)
        {
            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                            There was an error. Please, try again. Error message: {ex.Message}
                         </div>";
        }
        finally
        {
            //Re-render the page to show ScannedText
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async void UploadImportingFile(InputFileChangeEventArgs e)
    {

        try
        {
            DisplayProgressForImportingFile = true;
            ProgressPercentForImportingFile = 80;
            ProgressBarColourForImportingFile = "bg-info";

            string path = Path.Combine(
                Environment.CurrentDirectory,
                "wwwroot",
                "Uploads",
                "Tasks",
                e.File.Name);

            long MaxFileSize = 1024L * 1024L; //3MB max.

            await using FileStream FileStream = new(path, FileMode.Create);
            await e.File.OpenReadStream(MaxFileSize).CopyToAsync(FileStream);

            FileStream.Close();

            string Limitator = "\\wwwroot";
            int StartIndex = path.IndexOf(Limitator);
            string Result = "";

            if (StartIndex != -1)
            {
                Result = path.Substring(StartIndex + Limitator.Length);
            }

            UploadPath = Result;

            ProgressPercentForImportingFile = 100;
            ProgressBarColourForImportingFile = "bg-success";
            DisplayProgressForImportingFile = false;
        }
        catch (Exception ex)
        {
            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                            There was an error. Please, try again. Error message: {ex.Message}
                         </div>";

            ProgressPercentForImportingFile = 100;
            ProgressBarColourForImportingFile = "bg-danger";
        }
        finally
        {
            //Re-render the page to show ScannedText
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task ChangeRegistersPerPage(int registersPerPage)
    {
        try
        {
            //Basic configuration
            Message = "";

            RegistersPerPage = registersPerPage;

            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task SearchText(ChangeEventArgs args)
    {
        try
        {
            //Basic configuration
            Message = "";

            TextToSearch = args.Value.ToString();

            paginatedTasksDTO = tasksRepository
                                        .GetAllByTasksIdPaginated(
                                            TextToSearch,
                                            CheckStrict,
                                            1,
                                            RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task OnPreviousPage()
    {
        try
        {
            if (paginatedTasksDTO.HasPreviousPage)
            {
                paginatedTasksDTO = tasksRepository
                                            .GetAllByTasksIdPaginated(
                                                TextToSearch,
                                                CheckStrict,
                                                (paginatedTasksDTO.PageIndex - 1),
                                                paginatedTasksDTO.PageSize);
            }

            TotalRows = paginatedTasksDTO.TotalItems;
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task OnPageSelected(int pageIndex)
    {
        try
        {
            paginatedTasksDTO = tasksRepository
                                            .GetAllByTasksIdPaginated(
                                                TextToSearch,
                                                CheckStrict,
                                                pageIndex,
                                                paginatedTasksDTO.PageSize);

            TotalRows = paginatedTasksDTO.TotalItems;
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task OnNextPage()
    {
        try
        {
            if (paginatedTasksDTO.HasNextPage)
            {
                paginatedTasksDTO = tasksRepository
                                            .GetAllByTasksIdPaginated(
                                                TextToSearch,
                                                CheckStrict,
                                                (paginatedTasksDTO.PageIndex + 1),
                                                paginatedTasksDTO.PageSize);
            }

            TotalRows = paginatedTasksDTO.TotalItems;
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task ChangeView(string chosenView)
    {
        ChosenView = chosenView;

        //Re-render the page
        await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
    }

    private async Task Delete(int tasksId)
    {
        try
        {
            tasksRepository.DeleteByTasksId(tasksId);

            paginatedTasksDTO = tasksRepository
                                        .GetAllByTasksIdPaginated(
                                            TextToSearch,
                                            CheckStrict,
                                            1,
                                            RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            TextToSearch = "";

            Message = $@"<div class=""alert alert-success text-white font-weight-bold"" role=""alert"">
                                Register deleted correctly
                            </div>";
        }
        catch (Exception ex)
        {
            Failure failure = new()
            {
                Active = true,
                DateTimeCreation = DateTime.Now,
                DateTimeLastModification = DateTime.Now,
                UserCreationId = 1,
                UserLastModificationId = 1,
                EmergencyLevel = 1,
                Comment = "",
                Message = ex.Message,
                Source = ex.Source,
                StackTrace = ex.StackTrace
            };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task CheckList(int tasksId)
    {
        try
        {
            int[] lstTasksId = { tasksId };

            foreach (int TasksId in lstTasksId)
            {
                if (lstTasksChecked.Contains(TasksId))
                {
                    lstTasksChecked.Remove(TasksId);
                }
                else
                {
                    lstTasksChecked.Add(TasksId);
                }
            }
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }
    #endregion

    #region Exportations
    private async Task ExportToExcel()
    {
        try
        {
            //Set initial state
            Message = "";

            DownloadPathForExcel = $@"wwwroot/Downloads/ExcelFiles/{DateTime.Now.ToString("yyyy_MM_dd_HH_mm_ss_fff")}.xlsx";

            DataTable dtTasks = new();

            if (ExportationType == "just")
            {
                dtTasks = tasksRepository.GetAllByTasksIdInDataTable(lstTasksChecked);
            }
            else
            {
                dtTasks = tasksRepository.GetAllInDataTable();
            }

            tasksService.ExportToExcel(DownloadPathForExcel,
            dtTasks);

            //Delete wwwroot from path to download correctly
            DownloadPathForExcel = DownloadPathForExcel.Replace("wwwroot", "");
        }
        catch (Exception ex)
        {
            Failure failure = new()
            {
                Active = true,
                DateTimeCreation = DateTime.Now,
                DateTimeLastModification = DateTime.Now,
                UserCreationId = 1,
                UserLastModificationId = 1,
                EmergencyLevel = 1,
                Comment = "",
                Message = ex.Message,
                Source = ex.Source,
                StackTrace = ex.StackTrace
            };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task ExportToCSV()
    {
        try
        {
            //Set initial state
            Message = "";

            DownloadPathForCSV = $@"wwwroot/Downloads/CSVFiles/{DateTime.Now.ToString("yyyy_MM_dd_HH_mm_ss_fff")}.csv";

            List<Tasks?> lstTasks = [];

            if (ExportationType == "just")
            {
                lstTasks = tasksRepository.GetAllByTasksId(lstTasksChecked);
            }
            else
            {
                lstTasks = tasksRepository.GetAll();
            }

            tasksService.ExportToCSV(DownloadPathForCSV, lstTasks);

            //Delete wwwroot from path to download correctly
            DownloadPathForCSV = DownloadPathForCSV.Replace("wwwroot", "");            
        }
        catch (Exception ex)
        {
            Failure failure = new()
            {
                Active = true,
                DateTimeCreation = DateTime.Now,
                DateTimeLastModification = DateTime.Now,
                UserCreationId = 1,
                UserLastModificationId = 1,
                EmergencyLevel = 1,
                Comment = "",
                Message = ex.Message,
                Source = ex.Source,
                StackTrace = ex.StackTrace
            };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task ExportToPDF()
    {
        try
        {
            //Set initial state
            Message = "";

            List<Tasks?> lstTasks = [];

            if (ExportationType == "just")
            {
                lstTasks = tasksRepository.GetAllByTasksId(lstTasksChecked);
            }
            else
            {
                lstTasks = tasksRepository.GetAll();
            }

            DownloadPathForPDF = $@"wwwroot/Downloads/PDFFiles/{DateTime.Now.ToString("yyyy_MM_dd_HH_mm_ss_fff")}.pdf";

            tasksService.ExportToPDF(DownloadPathForPDF, lstTasks);

            //Delete wwwroot from path to download correctly
            DownloadPathForPDF = DownloadPathForPDF.Replace("wwwroot", "");
        }
        catch (Exception ex)
        {
            Failure failure = new()
            {
                Active = true,
                DateTimeCreation = DateTime.Now,
                DateTimeLastModification = DateTime.Now,
                UserCreationId = 1,
                UserLastModificationId = 1,
                EmergencyLevel = 1,
                Comment = "",
                Message = ex.Message,
                Source = ex.Source,
                StackTrace = ex.StackTrace
            };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }
    #endregion

    #region Massive actions
    private async Task Copy()
    {
        try
        {
            //Set initial state
            Message = "";

            List<Tasks?> lstTasks = [];

            if (MassiveActionType == "just")
            {
                lstTasks = tasksRepository.GetAllByTasksId(lstTasksChecked);
            }
            else
            {
                lstTasks = tasksRepository.GetAll();
            }

            foreach (Tasks tasks in lstTasks)
            {
                tasks.TasksId = 0;
                tasksRepository.Add(tasks);
            }

            paginatedTasksDTO = tasksRepository
                                                .GetAllByTasksIdPaginated(
                                                    "",
                                                    CheckStrict,
                                                    1,
                                                    RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            ChosenView = "list";

            MassiveActionMessage = $@"<div class=""alert alert-success text-white font-weight-bold"" role=""alert"">
                            Proceso de copiado finalizado correctamente
                         </div>";
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }

    private async Task Delete()
    {
        try
        {
            //Set initial state
            Message = "";

            List<Tasks?> lstTasks = [];

            if (MassiveActionType == "just")
            {
                lstTasks = tasksRepository.GetAllByTasksId(lstTasksChecked);
            }
            else
            {
                lstTasks = tasksRepository.GetAll();
            }

            foreach (Tasks tasks in lstTasks)
            {
                tasksRepository.DeleteByTasksId(tasks.TasksId);
            }

            paginatedTasksDTO = tasksRepository
                                                .GetAllByTasksIdPaginated(
                                                    "",
                                                    CheckStrict,
                                                    1,
                                                    RegistersPerPage);

            TotalRows = paginatedTasksDTO.TotalItems;

            ChosenView = "list";

            MassiveActionMessage = $@"<div class=""alert alert-success text-white font-weight-bold"" role=""alert"">
                            Proceso de eliminado finalizado correctamente
                         </div>";
        }
        catch (Exception ex)
        {
            Failure failure = new()
                {
                    Active = true,
                    DateTimeCreation = DateTime.Now,
                    DateTimeLastModification = DateTime.Now,
                    UserCreationId = 1,
                    UserLastModificationId = 1,
                    EmergencyLevel = 1,
                    Comment = "",
                    Message = ex.Message,
                    Source = ex.Source,
                    StackTrace = ex.StackTrace
                };

            failureRepository.Add(failure);

            Message = $@"<div class=""alert alert-danger text-white font-weight-bold"" role=""alert"">
                                There was an error. Please, try again. Error message: {ex.Message}
                            </div>";
        }
        finally
        {
            //Re-render the page
            await InvokeAsync(() => StateHasChanged()).ConfigureAwait(false);
        }
    }
    #endregion
}

